<!doctype html>
<html>
	<head>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<style>
			#all {
			}
			#toolbar {
				background-color: #aaa;
			}
			#body {
				background-color: #eee;
			}
			.cmp {
			}
			.cmpwrapper {
				background-color: #ddd;
			}
		</style>
	</head>
	<body>
		<div id=all>
			<div id=body class="contaier-fluid d-flex flex-column p-2 m-2">
				<comp v-for='comp in comps'
							:comp='comp'
							:key=comp.id></comp>
			</div>
			<div id=toolbar class="container-fluid d-flex justify-content-center p-2">
				<tool v-for='tool in tools'
							:tool='tool'
							:key='tool.id'></tool>
			</div>
		</div>
		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
		<script>
			//UNIVERSAL STATE
			function newTool(name, comp) {
				return {name: name, comp: comp}
			}
			function makeComp(tool) {
				return {tool: tool, contents: {}}
			}
			var state = {
				components: [],
				addComponent (tool) {
					this.components.push(makeComp(tool))
				},
				removeComponent (comp) {
					this.components.splice(this.components.indexOf(comp), 1)
				}
			}
			//TOOLBAR
			var tool = {
				props: ['tool'],
				template: '<span id="tool">\
										<button @click="add(tool)">{{ tool.name }}</button>\
									</span>',
				methods: {
					add: function(tool) {
						state.addComponent(tool)
					}
				}
			}
			var toolbar = new Vue({
				el: '#toolbar',
				data: {
					tools: [newTool("Text", "textComp"),
									newTool("Blockly", "blocklyComp"),
									newTool("Video", "videoComp")]
				},
				components: {
					'tool': tool
				}
			})
			//EDITABLE THINGS
			Vue.component('editable-text', {
				props: ['text', 'isLarge'],
				data: function () {
					return {editing: false,
									newText: "",
									initial: this.text}
				},
				template: '<span>\
										<span v-if="!editing">\
											<span v-if="!isEmpty(newText)" @click="editing = true">{{initial}}</span>\
											<span v-if="newText.length > 0" @click="editing = true">{{text}}</span>\
										</span>\
										<span v-if="editing">\
											<input v-if="!isLarge" v-model="newText" :placeholder="initial" @keyup="keyPressed"></input>\
											<textarea v-if="isLarge" v-model="newText" :placeholder="initial" @keyup="keyPressed"></textarea>\
											<button @click="complete">âœ“</button>\
										</span>\
									</span>',
				methods: {
					isEmpty: function (str) {
						return /\S/.test(str)
					},
					keyPressed: function (e) {
						if (!this.isLarge && e.keyCode == 13) {
							this.complete()
						}
					},
					complete: function () {
						this.editing = false
						this.$emit('update', this.newText)
					}
				}
			})
			//COMPONENT LIST
			var comp = {
				name: 'comp',
				props: ['comp'],
				template: '<span class="text-justify">\
										<component v-bind:is="comp.tool.comp" :comp="comp"></component>\
										<button @click="remove(comp)">-</button>\
									</span>',
				methods: {
					remove: function (comp) {
						state.removeComponent(comp)
					}
				}
			}
			Vue.component('textComp', {
				props: ['comp'],
				created() {
					if (this.comp.contents.title == null) {
						Vue.set(this.comp.contents, 'title', 'Title Here')
					}
					if (this.comp.contents.text == null) {
						Vue.set(this.comp.contents, 'text', 'Lorem Ipsum')
					}
				},
				template: '<div class="cmp">\
										<h2><editable-text :text="comp.contents.title"\
																			:isLarge="false"\
																			@update="function (value) {comp.contents.title = value}"></editable-text></h2>\
										<p><editable-text :text="comp.contents.text"\
																			:isLarge="true"\
																			@update="function (value) {comp.contents.text = value}"></editable-text></p>\
									</div>'
			})
			Vue.component('blocklyComp', {
				props: ['comp'],
				template: '<div class="cmp">iamblockly\
									</div>'
			})
			Vue.component('videoComp', {
				props: ['comp'],
				created() {
					if (this.comp.contents.url == null) {
						Vue.set(this.comp.contents, 'url', 'vjnqABgxfO0')
					}
				},
				template: '<div class="cmp">\
										<p></p><editable-text :text="comp.contents.url"\
																					:isLarge="false"\
																					@update="function (value) {comp.contents.url = value}"></editable-text></p>\
										<iframe width="560" height="315" :src="youtubeify(comp.contents.url)" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>\
									</div>',
				methods: {
					youtubeify: function (videoID) {
						return "https://www.youtube.com/embed/" + videoID
					},
					updateUrl: function (videoID) {
						Vue.set(this.comp.contents, 'url', videoID)
					}
				}
			})
			var body = new Vue({
				el: '#body',
				data: {
					comps: state.components
				},
				components: {
					'comp': comp
				}
			})
		</script>
	</body>
</html>
